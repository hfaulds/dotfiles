#!/bin/zsh

set -e

if [[ "$(which brew || echo "")" == "" ]]; then
  echo "install homebrew"
  if [[ "$OSTYPE" == "linux-gnu"* ]]; then
    export CI=true
  fi
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

if [[ "$OSTYPE" == "linux-gnu"* ]]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"

  echo "brew bundle"
  # brew bundle -q --file Brewfile.linux
elif [[ "$OSTYPE" == "darwin"* ]]; then
  eval "$(/usr/local/bin/brew shellenv)"
  echo "macos defaults"
  defaults write com.apple.Dock tilesize -int 1
  defaults write com.apple.Dock autohide-delay -float 5
  killall Dock

  echo "brew bundle"
  # brew bundle

  echo "brew post-install steps"
  $(brew --prefix)/opt/fzf/install --all
fi

echo "git submodule update"
git submodule init
git submodule update

pwd=$(pwd)

if [[ "$OSTYPE" == "linux-gnu"* ]]; then
  conf=$(find config -maxdepth 1 -print0)
elif [[ "$OSTYPE" == "darwin"* ]]; then
  conf=$(find config -d 1 -print0)
fi

echo "$conf" | while read -d $'\0' f; do
  ff=$(basename $f)
  echo "link $pwd/config/$ff -> $HOME/$ff"
  rm -rf $HOME/$ff
  ln -Fs "$pwd/config/$ff" "$HOME"
done

if [[ "$SHELL" == "/bin/zsh" ]]; then
  source ~/.zshrc
fi

echo "install language servers"
if [[ "$OSTYPE" == "darwin"* ]]; then
  gem install solargraph
  npm install -g javascript-typescript-langserver
  npm install -g bash-language-server
fi

go install golang.org/x/tools/gopls@latest

if [[ "$OSTYPE" == "linux-gnu"* ]]; then
  echo "configure git on codespaces"
  git config --global credential.helper cache
  printf "protocol=https\\nhost=github.com\\nusername=%s\\npassword=%s\\n" "hfaulds" "$GITHUB_TOKEN" | git credential approve

  echo "configuring shell on codespaces"
  sudo chsh -s "$(which zsh)" "$(whoami)"
fi
